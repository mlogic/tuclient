#!/usr/bin/env python
"""Unit tests for the collectd_os plugin"""
# Copyright (c) 2017-2019 Yan Li, TuneUp.ai <yanli@tuneup.ai>.
# All rights reserved.
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License version 2.1 as published by the Free Software Foundation.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, see
# https://www.gnu.org/licenses/old-licenses/lgpl-2.1.html
from __future__ import absolute_import, division, print_function, unicode_literals

__author__ = 'Yan Li'
__copyright__ = 'Copyright (c) 2017-2019 Yan Li, TuneUp.ai <yanli@tuneup.ai>. All rights reserved.'
__license__ = 'LGPLv2.1'
__docformat__ = 'reStructuredText'

import logging
import tuclient
from tuclient_extensions.collectd_os import Getter
import unittest


class MockCollectd:
    def add_plugin(self, plugin):
        del plugin
        pass

    def register_callback(self, plugin, callback):
        del plugin, callback
        pass

    def start(self):
        pass

    def stop(self):
        pass


class TestCollectdOS(unittest.TestCase):
    def setUp(self):
        self._logger = tuclient.get_stdout_logger()
        self._logger.setLevel(logging.WARNING)

    def test_start_stop(self):
        collectd_os = None
        try:
            collectd_os = Getter(self._logger, 'host_a')
            collectd_os.start()
            num_pis = len(collectd_os.pi_names)
            self.assertGreater(num_pis, 1)
            for _ in range(3):
                self.assertEqual(num_pis, len(collectd_os.collect()))
        finally:
            collectd_os.stop()

    def test_parsing_data(self):
        collectd_os = None
        try:
            collectd_os = Getter(self._logger, 'host_a', collectd_instance=MockCollectd())
            self._records_received = 0
            collectd_os.start()
            collectd_os._on_receiving_cpu_data('host_a', 'cpu',
                                               [(0, 'host_a'), (8, 1552233781.7930737), (9, 1073741824), (2, 'cpu'),
                                                (3, '0'), (4, 'cpu'), (5, 'user'),
                                                (6, [(2, 285758)]), (8, 1552233781.7930973), (3, '5'),
                                                (6, [(2, 265177)]), (8, 1552233781.7931006),
                                                (3, '6'), (6, [(2, 251558)]), (8, 1552233781.7931015), (3, '7'),
                                                (6, [(2, 278477)]),
                                                (8, 1552233781.7930815), (3, '2'), (6, [(2, 293672)]),
                                                (8, 1552233781.7931023), (3, '0'), (5, 'system'),
                                                (6, [(2, 257242)]), (8, 1552233781.7931037), (3, '2'),
                                                (6, [(2, 256617)]), (8, 1552233781.7931075),
                                                (3, '3'), (6, [(2, 264249)]), (8, 1552233781.7931085), (3, '4'),
                                                (6, [(2, 257656)]),
                                                (8, 1552233781.7930856), (3, '3'), (5, 'user'), (6, [(2, 278977)]),
                                                (8, 1552233781.7930925), (3, '4'),
                                                (6, [(2, 321941)]), (8, 1552233781.79311), (3, '6'), (5, 'system'),
                                                (6, [(2, 275277)]),
                                                (8, 1552233781.793103), (3, '1'), (6, [(2, 260026)]),
                                                (8, 1552233781.7931106), (3, '7'),
                                                (6, [(2, 258785)]), (8, 1552233781.7931204), (3, '1'), (5, 'wait'),
                                                (6, [(2, 158)]),
                                                (8, 1552233781.7930782), (5, 'user'), (6, [(2, 303513)]),
                                                (8, 1552233781.793119), (3, '0'), (5, 'wait'),
                                                (6, [(2, 41593)]), (8, 1552233781.7931223), (3, '4'),
                                                (6, [(2, 176)]), (8, 1552233781.7931216), (3, '3'),
                                                (6, [(2, 189)]), (8, 1552233781.793121), (3, '2'), (6, [(2, 170)]),
                                                (8, 1552233781.7931955), (3, '6'),
                                                (6, [(2, 237)]), (8, 1552233781.7932122), (3, '7'), (6, [(2, 179)]),
                                                (8, 1552233781.7931092), (3, '5'),
                                                (5, 'system'), (6, [(2, 267355)]), (8, 1552233781.7932143),
                                                (3, '2'), (5, 'nice'), (6, [(2, 60371)]),
                                                (0, 'host_a'), (8, 1552233781.7933738), (9, 1073741824), (2, 'cpu'),
                                                (3, '3'), (4, 'cpu'), (5, 'nice'),
                                                (6, [(2, 71744)]), (8, 1552233781.793376), (3, '5'),
                                                (6, [(2, 55160)]), (8, 1552233781.793377), (3, '6'),
                                                (6, [(2, 55767)]), (8, 1552233781.7933776), (3, '7'),
                                                (6, [(2, 55048)]), (8, 1552233781.7935786), (3, '0'),
                                                (5, 'interrupt'), (6, [(2, 0)]), (8, 1552233781.7935987), (3, '1'),
                                                (6, [(2, 0)]), (8, 1552233781.7935994),
                                                (3, '2'), (6, [(2, 0)]), (8, 1552233781.7936), (3, '3'),
                                                (6, [(2, 0)]), (8, 1552233781.7936008), (3, '4'),
                                                (6, [(2, 0)]), (8, 1552233781.7936015), (3, '5'), (6, [(2, 0)]),
                                                (8, 1552233781.7936995), (3, '6'),
                                                (6, [(2, 0)]), (8, 1552233781.7937024), (3, '7'), (6, [(2, 0)]),
                                                (8, 1552233781.7937033), (3, '0'),
                                                (5, 'softirq'), (6, [(2, 202311)]), (8, 1552233781.7932131),
                                                (5, 'nice'), (6, [(2, 56548)]),
                                                (8, 1552233781.793705), (3, '2'), (5, 'softirq'), (6, [(2, 36560)]),
                                                (8, 1552233781.7937057), (3, '3'),
                                                (6, [(2, 12998)]), (8, 1552233781.793708), (3, '4'),
                                                (6, [(2, 5668)]), (8, 1552233781.793709), (3, '5'),
                                                (6, [(2, 4424)]), (8, 1552233781.7937098), (3, '6'),
                                                (6, [(2, 1917)]), (8, 1552233781.7937107), (3, '7'),
                                                (6, [(2, 7730)]), (8, 1552233781.7937117), (3, '0'), (5, 'steal'),
                                                (6, [(2, 0)]), (8, 1552233781.7937143),
                                                (3, '1'), (6, [(2, 0)]), (8, 1552233781.7937152), (3, '2'),
                                                (6, [(2, 0)]), (8, 1552233781.7933753),
                                                (3, '4'), (5, 'nice'), (6, [(2, 66966)])])
            collectd_os._on_receiving_cpu_data('host_a', 'cpu',
                                               [(0, 'host_a'), (8, 1552233781.793716), (9, 1073741824), (2, 'cpu'),
                                                (3, '3'), (4, 'cpu'), (5, 'steal'), (6, [(2, 0)]),
                                                (8, 1552233781.7937176), (3, '5'), (6, [(2, 0)]),
                                                (8, 1552233781.7937183), (3, '6'), (6, [(2, 0)]),
                                                (8, 1552233781.7937207), (3, '7'), (6, [(2, 0)]),
                                                (8, 1552233781.793722), (3, '0'), (5, 'idle'), (6, [(2, 13185961)]),
                                                (8, 1552233781.7937229), (3, '1'), (6, [(2, 19529)]),
                                                (8, 1552233781.7937238), (3, '2'), (6, [(2, 18178)]),
                                                (8, 1552233781.7931232), (3, '5'), (5, 'wait'), (6, [(2, 177)]),
                                                (8, 1552233781.7937253), (3, '4'), (5, 'idle'), (6, [(2, 18777)]),
                                                (8, 1552233781.7937312), (3, '5'), (6, [(2, 20264)]),
                                                (8, 1552233781.7932136), (3, '1'), (5, 'nice'), (6, [(2, 61070)]),
                                                (8, 1552233781.7937322), (3, '6'), (5, 'idle'), (6, [(2, 20741)]),
                                                (8, 1552233781.793717), (3, '4'), (5, 'steal'), (6, [(2, 0)]),
                                                (8, 1552233781.793733), (3, '7'), (5, 'idle'), (6, [(2, 20563)]),
                                                (8, 1552233781.7937245), (3, '3'), (6, [(2, 16229)]),
                                                (8, 1552233781.793704), (3, '1'), (5, 'softirq'), (6, [(2, 84211)]),
                                                (8, 1552233782.793251), (3, '0'), (5, 'user'), (6, [(2, 285759)]),
                                                (8, 1552233782.7932556), (3, '1'), (6, [(2, 303513)]),
                                                (8, 1552233782.793258), (3, '2'), (6, [(2, 293673)]),
                                                (8, 1552233782.7932603), (3, '3'), (6, [(2, 278978)]),
                                                (8, 1552233782.7932622), (3, '4'), (6, [(2, 321943)]),
                                                (8, 1552233782.7932649), (3, '6'), (6, [(2, 251558)]),
                                                (8, 1552233782.7932642), (3, '5'), (6, [(2, 265178)]), (0, 'host_a'),
                                                (8, 1552233782.7932656), (9, 1073741824), (2, 'cpu'), (3, '7'),
                                                (4, 'cpu'), (5, 'user'), (6, [(2, 278477)]), (8, 1552233782.7932694),
                                                (3, '4'), (5, 'system'), (6, [(2, 257657)]), (8, 1552233782.79327),
                                                (3, '5'), (6, [(2, 267355)]), (8, 1552233782.793271), (3, '6'),
                                                (6, [(2, 275277)]), (8, 1552233782.7932718), (3, '7'),
                                                (6, [(2, 258785)]), (8, 1552233782.7932725), (3, '0'), (5, 'wait'),
                                                (6, [(2, 41593)]), (8, 1552233782.7932732), (3, '1'), (6, [(2, 158)]),
                                                (8, 1552233782.7932742), (3, '2'), (6, [(2, 170)]),
                                                (8, 1552233782.7932749), (3, '3'), (6, [(2, 189)]),
                                                (8, 1552233782.7932754), (3, '4'), (6, [(2, 176)]),
                                                (8, 1552233782.793276), (3, '5'), (6, [(2, 177)]),
                                                (8, 1552233782.7932765), (3, '6'), (6, [(2, 237)]),
                                                (8, 1552233782.7932773), (3, '7'), (6, [(2, 179)]),
                                                (8, 1552233782.7932782), (3, '0'), (5, 'nice'), (6, [(2, 56548)]),
                                                (8, 1552233782.7932792), (3, '1'), (6, [(2, 61070)]),
                                                (8, 1552233782.79328), (3, '2'), (6, [(2, 60371)]),
                                                (8, 1552233782.793281), (3, '3'), (6, [(2, 71745)]),
                                                (8, 1552233782.793282), (3, '4'), (6, [(2, 66967)]),
                                                (8, 1552233782.7932827), (3, '5'), (6, [(2, 55160)]),
                                                (8, 1552233782.7932925), (3, '6'), (6, [(2, 55767)]),
                                                (8, 1552233782.793294), (3, '7'), (6, [(2, 55048)]),
                                                (8, 1552233782.7932951), (3, '0'), (5, 'interrupt'), (6, [(2, 0)]),
                                                (8, 1552233782.7932959), (3, '1'), (6, [(2, 0)]),
                                                (8, 1552233782.7932966), (3, '2'), (6, [(2, 0)]),
                                                (8, 1552233782.7932975), (3, '3'), (6, [(2, 0)]), (0, 'host_a'),
                                                (8, 1552233782.7932673), (9, 1073741824), (2, 'cpu'), (3, '1'),
                                                (4, 'cpu'), (5, 'system'), (6, [(2, 260028)]), (8, 1552233782.7933009),
                                                (3, '5'), (5, 'interrupt'), (6, [(2, 0)]), (8, 1552233782.7933018),
                                                (3, '6'), (6, [(2, 0)]), (8, 1552233782.7933025), (3, '7'),
                                                (6, [(2, 0)]), (8, 1552233782.7933035), (3, '0'), (5, 'softirq'),
                                                (6, [(2, 202311)]), (8, 1552233782.7933042), (3, '1'),
                                                (6, [(2, 84211)]), (8, 1552233782.7933052), (3, '2'), (6, [(2, 36560)]),
                                                (8, 1552233782.793306), (3, '3'), (6, [(2, 12998)]),
                                                (8, 1552233782.7933097), (3, '4'), (6, [(2, 5668)]),
                                                (8, 1552233782.7933118), (3, '5'), (6, [(2, 4424)]),
                                                (8, 1552233782.793313), (3, '6'), (6, [(2, 1917)]),
                                                (8, 1552233782.7933137), (3, '7'), (6, [(2, 7730)]),
                                                (8, 1552233782.7933147), (3, '0'), (5, 'steal'), (6, [(2, 0)]),
                                                (8, 1552233782.7933156), (3, '1'), (6, [(2, 0)]),
                                                (8, 1552233782.7933183), (3, '2'), (6, [(2, 0)]),
                                                (8, 1552233782.7933187), (3, '3'), (6, [(2, 0)]),
                                                (8, 1552233782.7933192), (3, '4'), (6, [(2, 0)]), (8, 1552233782.79332),
                                                (3, '5'), (6, [(2, 0)]), (8, 1552233782.7933204), (3, '6'),
                                                (6, [(2, 0)]), (8, 1552233782.793321), (3, '7'), (6, [(2, 0)]),
                                                (8, 1552233782.7933233), (3, '0'), (5, 'idle'), (6, [(2, 13186058)]),
                                                (8, 1552233782.7932665), (5, 'system'), (6, [(2, 257242)]),
                                                (8, 1552233782.7932677), (3, '2'), (6, [(2, 256617)]),
                                                (8, 1552233782.793325), (3, '3'), (5, 'idle'), (6, [(2, 16326)])])
            collectd_os._on_receiving_cpu_data('host_a', 'cpu',
                                               [(0, 'host_a'), (8, 1552233782.7932684), (9, 1073741824), (2, 'cpu'),
                                                (3, '3'), (4, 'cpu'), (5, 'system'),
                                                (6, [(2, 264249)]), (8, 1552233782.7933273), (3, '5'), (5, 'idle'),
                                                (6, [(2, 20362)]),
                                                (8, 1552233782.7933278), (3, '6'), (6, [(2, 20839)]),
                                                (8, 1552233782.7933283), (3, '7'), (6, [(2, 20661)]),
                                                (8, 1552233782.7932985), (3, '4'), (5, 'interrupt'), (6, [(2, 0)]),
                                                (8, 1552233782.7933238), (3, '1'),
                                                (5, 'idle'), (6, [(2, 19628)]), (8, 1552233782.7933245), (3, '2'),
                                                (6, [(2, 18278)]),
                                                (8, 1552233782.7933254), (3, '4'), (6, [(2, 18873)]),
                                                (8, 1552233783.7933295), (3, '0'), (5, 'user'),
                                                (6, [(2, 285760)]), (8, 1552233783.7933345), (3, '1'),
                                                (6, [(2, 303514)]), (8, 1552233783.7933376),
                                                (3, '2'), (6, [(2, 293674)]), (8, 1552233783.7933404), (3, '3'),
                                                (6, [(2, 278978)]),
                                                (8, 1552233783.7933433), (3, '4'), (6, [(2, 321944)]),
                                                (8, 1552233783.793346), (3, '5'),
                                                (6, [(2, 265179)]), (8, 1552233783.7933466), (3, '6'),
                                                (6, [(2, 251559)]), (8, 1552233783.7933471),
                                                (3, '7'), (6, [(2, 278477)]), (8, 1552233783.7933488), (3, '0'),
                                                (5, 'system'), (6, [(2, 257242)]),
                                                (8, 1552233783.7933493), (3, '1'), (6, [(2, 260028)]),
                                                (8, 1552233783.7933517), (3, '2'),
                                                (6, [(2, 256618)]), (8, 1552233783.793353), (3, '4'),
                                                (6, [(2, 257657)]), (8, 1552233783.7933524),
                                                (3, '3'), (6, [(2, 264249)]), (8, 1552233783.7933545), (3, '6'),
                                                (6, [(2, 275278)]),
                                                (8, 1552233783.793355), (3, '7'), (6, [(2, 258785)]),
                                                (8, 1552233783.7933574), (3, '0'), (5, 'wait'),
                                                (6, [(2, 41593)]), (0, 'host_a'), (8, 1552233783.7933538),
                                                (9, 1073741824), (2, 'cpu'), (3, '5'),
                                                (4, 'cpu'), (5, 'system'), (6, [(2, 267355)]), (8, 1552233783.7933607),
                                                (5, 'wait'), (6, [(2, 177)]),
                                                (8, 1552233783.7933612), (3, '6'), (6, [(2, 237)]),
                                                (8, 1552233783.793362), (3, '7'), (6, [(2, 179)]),
                                                (8, 1552233783.7933633), (3, '0'), (5, 'nice'), (6, [(2, 56548)]),
                                                (8, 1552233783.7933645), (3, '1'),
                                                (6, [(2, 61070)]), (8, 1552233783.7933652), (3, '2'), (6, [(2, 60371)]),
                                                (8, 1552233783.793366), (3, '3'),
                                                (6, [(2, 71746)]), (8, 1552233783.7933667), (3, '4'), (6, [(2, 66967)]),
                                                (8, 1552233783.7933671), (3, '5'),
                                                (6, [(2, 55160)]), (8, 1552233783.7933679), (3, '6'), (6, [(2, 55768)]),
                                                (8, 1552233783.7933686), (3, '7'),
                                                (6, [(2, 55048)]), (8, 1552233783.7933698), (3, '0'), (5, 'interrupt'),
                                                (6, [(2, 0)]),
                                                (8, 1552233783.7933705), (3, '1'), (6, [(2, 0)]),
                                                (8, 1552233783.7933712), (3, '2'), (6, [(2, 0)]),
                                                (8, 1552233783.7933593), (3, '3'), (5, 'wait'), (6, [(2, 189)]),
                                                (8, 1552233783.7933726), (3, '4'),
                                                (5, 'interrupt'), (6, [(2, 0)]), (8, 1552233783.7933733), (3, '5'),
                                                (6, [(2, 0)]), (8, 1552233783.793374),
                                                (3, '6'), (6, [(2, 0)]), (8, 1552233783.793375), (3, '7'),
                                                (6, [(2, 0)]), (8, 1552233783.7933762),
                                                (3, '0'), (5, 'softirq'), (6, [(2, 202311)]), (8, 1552233783.7933772),
                                                (3, '1'), (6, [(2, 84211)]),
                                                (8, 1552233783.7933779), (3, '2'), (6, [(2, 36560)]),
                                                (8, 1552233783.7933786), (3, '3'), (6, [(2, 12998)]),
                                                (0, 'host_a'), (8, 1552233783.7933795), (9, 1073741824), (2, 'cpu'),
                                                (3, '4'), (4, 'cpu'), (5, 'softirq'),
                                                (6, [(2, 5668)]), (8, 1552233783.7933803), (3, '5'), (6, [(2, 4424)]),
                                                (8, 1552233783.793358), (3, '1'),
                                                (5, 'wait'), (6, [(2, 158)]), (8, 1552233783.7933815), (3, '7'),
                                                (5, 'softirq'), (6, [(2, 7730)]),
                                                (8, 1552233783.7933824), (3, '0'), (5, 'steal'), (6, [(2, 0)]),
                                                (8, 1552233783.7933831), (3, '1'),
                                                (6, [(2, 0)]), (8, 1552233783.7933838), (3, '2'), (6, [(2, 0)]),
                                                (8, 1552233783.7933846), (3, '3'),
                                                (6, [(2, 0)]), (8, 1552233783.7933853), (3, '4'), (6, [(2, 0)]),
                                                (8, 1552233783.793386), (3, '5'),
                                                (6, [(2, 0)]), (8, 1552233783.793387), (3, '6'), (6, [(2, 0)]),
                                                (8, 1552233783.7933877), (3, '7'),
                                                (6, [(2, 0)]), (8, 1552233783.793389), (3, '0'), (5, 'idle'),
                                                (6, [(2, 13186157)]),
                                                (8, 1552233783.7933898), (3, '1'), (6, [(2, 19726)]),
                                                (8, 1552233783.7933908), (3, '2'), (6, [(2, 18375)]),
                                                (8, 1552233783.7933917), (3, '3'), (6, [(2, 16424)]),
                                                (8, 1552233783.7933981), (3, '4'), (6, [(2, 18972)]),
                                                (8, 1552233783.793399), (3, '5'), (6, [(2, 20461)]),
                                                (8, 1552233783.7934), (3, '6'), (6, [(2, 20937)]),
                                                (8, 1552233783.793402), (3, '7'), (6, [(2, 20760)]),
                                                (8, 1552233783.7933586), (3, '2'), (5, 'wait'),
                                                (6, [(2, 170)]), (8, 1552233783.79336), (3, '4'), (6, [(2, 176)]),
                                                (8, 1552233783.793372), (3, '3'),
                                                (5, 'interrupt'), (6, [(2, 0)])])
            self.assertEqual(64, len(collectd_os.pi_names))
            expected_pi_names = ['host_a/cpu/0/idle', 'host_a/cpu/0/interrupt', 'host_a/cpu/0/nice',
                                 'host_a/cpu/0/softirq', 'host_a/cpu/0/steal', 'host_a/cpu/0/system',
                                 'host_a/cpu/0/user', 'host_a/cpu/0/wait', 'host_a/cpu/1/idle',
                                 'host_a/cpu/1/interrupt', 'host_a/cpu/1/nice', 'host_a/cpu/1/softirq',
                                 'host_a/cpu/1/steal', 'host_a/cpu/1/system', 'host_a/cpu/1/user', 'host_a/cpu/1/wait',
                                 'host_a/cpu/2/idle', 'host_a/cpu/2/interrupt', 'host_a/cpu/2/nice',
                                 'host_a/cpu/2/softirq', 'host_a/cpu/2/steal', 'host_a/cpu/2/system',
                                 'host_a/cpu/2/user', 'host_a/cpu/2/wait', 'host_a/cpu/3/idle',
                                 'host_a/cpu/3/interrupt', 'host_a/cpu/3/nice', 'host_a/cpu/3/softirq',
                                 'host_a/cpu/3/steal', 'host_a/cpu/3/system', 'host_a/cpu/3/user', 'host_a/cpu/3/wait',
                                 'host_a/cpu/4/idle', 'host_a/cpu/4/interrupt', 'host_a/cpu/4/nice',
                                 'host_a/cpu/4/softirq', 'host_a/cpu/4/steal', 'host_a/cpu/4/system',
                                 'host_a/cpu/4/user', 'host_a/cpu/4/wait', 'host_a/cpu/5/idle',
                                 'host_a/cpu/5/interrupt', 'host_a/cpu/5/nice', 'host_a/cpu/5/softirq',
                                 'host_a/cpu/5/steal', 'host_a/cpu/5/system', 'host_a/cpu/5/user', 'host_a/cpu/5/wait',
                                 'host_a/cpu/6/idle', 'host_a/cpu/6/interrupt', 'host_a/cpu/6/nice',
                                 'host_a/cpu/6/softirq', 'host_a/cpu/6/steal', 'host_a/cpu/6/system',
                                 'host_a/cpu/6/user', 'host_a/cpu/6/wait', 'host_a/cpu/7/idle',
                                 'host_a/cpu/7/interrupt', 'host_a/cpu/7/nice', 'host_a/cpu/7/softirq',
                                 'host_a/cpu/7/steal', 'host_a/cpu/7/system', 'host_a/cpu/7/user', 'host_a/cpu/7/wait']
            self.assertListEqual(expected_pi_names, collectd_os.pi_names)
            self.assertListEqual(
             [0.9795918367346939, -1.0, -1.0, -1.0, -1.0, -1.0, -0.9795918367346939, -1.0, 0.9603960396039604, -1.0,
              -1.0, -1.0, -1.0, -0.9603960396039604, -1.0, -1.0, 0.9801980198019802, -1.0, -1.0, -1.0, -1.0, -1.0,
              -0.9801980198019802, -1.0, 0.9595959595959596, -1.0, -0.9797979797979798, -1.0, -1.0, -1.0,
              -0.9797979797979798, -1.0, 0.9199999999999999, -1.0, -0.98, -1.0, -1.0, -0.98, -0.96, -1.0,
              0.9797979797979799, -1.0, -1.0, -1.0, -1.0, -1.0, -0.9797979797979798, -1.0, 1.0, -1.0, -1.0, -1.0, -1.0,
              -1.0, -1.0, -1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0],
             collectd_os.collect())
            collectd_os._on_receiving_cpu_data('host_a', 'cpu',
                                               [(0, 'host_a'), (8, 1552233783.7933807), (9, 1073741824), (2, 'cpu'),
                                                (3, '6'), (4, 'cpu'), (5, 'softirq'),
                                                (6, [(2, 1917)]), (8, 1552233784.7932494), (3, '0'), (5, 'user'),
                                                (6, [(2, 285760)]),
                                                (8, 1552233784.7932541), (3, '1'), (6, [(2, 303518)]),
                                                (8, 1552233784.7932563), (3, '2'),
                                                (6, [(2, 293676)]), (8, 1552233784.7932584), (3, '3'),
                                                (6, [(2, 278979)]), (8, 1552233784.7932608),
                                                (3, '4'), (6, [(2, 321944)]), (8, 1552233784.7932634), (3, '5'),
                                                (6, [(2, 265180)]),
                                                (8, 1552233784.7932642), (3, '6'), (6, [(2, 251560)]),
                                                (8, 1552233784.7932668), (3, '0'), (5, 'system'),
                                                (6, [(2, 257242)]), (8, 1552233784.7932649), (3, '7'), (5, 'user'),
                                                (6, [(2, 278477)]),
                                                (8, 1552233784.7932675), (3, '1'), (5, 'system'), (6, [(2, 260028)]),
                                                (8, 1552233784.7932682), (3, '2'),
                                                (6, [(2, 256620)]), (8, 1552233784.7932694), (3, '4'),
                                                (6, [(2, 257658)]), (8, 1552233784.7932713),
                                                (3, '7'), (6, [(2, 258786)]), (8, 1552233784.7932727), (3, '0'),
                                                (5, 'wait'), (6, [(2, 41593)]),
                                                (8, 1552233784.7932687), (3, '3'), (5, 'system'), (6, [(2, 264250)]),
                                                (8, 1552233784.7932706), (3, '6'),
                                                (6, [(2, 275278)]), (8, 1552233784.793274), (3, '2'), (5, 'wait'),
                                                (6, [(2, 170)]),
                                                (8, 1552233784.7932732), (3, '1'), (6, [(2, 158)]),
                                                (8, 1552233784.7932746), (3, '3'), (6, [(2, 189)]),
                                                (8, 1552233784.793277), (3, '7'), (6, [(2, 179)]),
                                                (8, 1552233784.7932754), (3, '4'), (6, [(2, 179)]),
                                                (8, 1552233784.7932765), (3, '6'), (6, [(2, 237)]), (0, 'host_a'),
                                                (8, 1552233784.7932699),
                                                (9, 1073741824), (2, 'cpu'), (3, '5'), (4, 'cpu'), (5, 'system'),
                                                (6, [(2, 267355)]),
                                                (8, 1552233784.7932801), (3, '3'), (5, 'nice'), (6, [(2, 71746)]),
                                                (8, 1552233784.7932806), (3, '4'),
                                                (6, [(2, 66967)]), (8, 1552233784.7932813), (3, '5'), (6, [(2, 55161)]),
                                                (8, 1552233784.793282), (3, '6'),
                                                (6, [(2, 55768)]), (8, 1552233784.7932832), (3, '7'), (6, [(2, 55048)]),
                                                (8, 1552233784.7932847), (3, '0'),
                                                (5, 'interrupt'), (6, [(2, 0)]), (8, 1552233784.7932854), (3, '1'),
                                                (6, [(2, 0)]), (8, 1552233784.793286),
                                                (3, '2'), (6, [(2, 0)]), (8, 1552233784.7932866), (3, '3'),
                                                (6, [(2, 0)]), (8, 1552233784.7932873),
                                                (3, '4'), (6, [(2, 0)]), (8, 1552233784.7932878), (3, '5'),
                                                (6, [(2, 0)]), (8, 1552233784.7932885),
                                                (3, '6'), (6, [(2, 0)]), (8, 1552233784.7932892), (3, '7'),
                                                (6, [(2, 0)]), (8, 1552233784.7932901),
                                                (3, '0'), (5, 'softirq'), (6, [(2, 202312)]), (8, 1552233784.7932909),
                                                (3, '1'), (6, [(2, 84211)]),
                                                (8, 1552233784.7932916), (3, '2'), (6, [(2, 36560)]),
                                                (8, 1552233784.7932923), (3, '3'), (6, [(2, 12998)]),
                                                (8, 1552233784.7932942), (3, '4'), (6, [(2, 5668)]),
                                                (8, 1552233784.7932951), (3, '5'), (6, [(2, 4424)]),
                                                (8, 1552233784.7932959), (3, '6'), (6, [(2, 1917)]),
                                                (8, 1552233784.7932966), (3, '7'), (6, [(2, 7730)]),
                                                (8, 1552233784.7932975), (3, '0'), (5, 'steal'), (6, [(2, 0)]),
                                                (8, 1552233784.7932758), (3, '5'),
                                                (5, 'wait'), (6, [(2, 180)])])
            self.assertListEqual(
             [0.98, -1.0, -1.0, -1.0, -1.0, -1.0, -0.98, -1.0, 0.9797979797979799, -1.0, -1.0, -1.0, -1.0, -1.0,
              -0.9797979797979798, -1.0, 0.9595959595959596, -1.0, -1.0, -1.0, -1.0, -0.9797979797979798,
              -0.9797979797979798, -1.0, 0.9797979797979799, -1.0, -0.9797979797979798, -1.0, -1.0, -1.0, -1.0, -1.0,
              0.98, -1.0, -1.0, -1.0, -1.0, -1.0, -0.98, -1.0, 0.98, -1.0, -1.0, -1.0, -1.0, -1.0, -0.98, -1.0,
              0.9405940594059405, -1.0, -0.9801980198019802, -1.0, -1.0, -0.9801980198019802, -0.9801980198019802, -1.0,
              1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0], collectd_os.collect())
            collectd_os._on_receiving_cpu_data('host_a', 'cpu',
                                               [(0, 'host_a'), (8, 1552233784.793299), (9, 1073741824), (2, 'cpu'),
                                                (3, '2'), (4, 'cpu'), (5, 'steal'),
                                                (6, [(2, 0)]), (8, 1552233784.7932997), (3, '3'), (6, [(2, 0)]),
                                                (8, 1552233784.7933004), (3, '4'),
                                                (6, [(2, 0)]), (8, 1552233784.793301), (3, '5'), (6, [(2, 0)]),
                                                (8, 1552233784.7933018), (3, '6'),
                                                (6, [(2, 0)]), (8, 1552233784.7933025), (3, '7'), (6, [(2, 0)]),
                                                (8, 1552233784.7933037), (3, '0'),
                                                (5, 'idle'), (6, [(2, 13186255)]), (8, 1552233784.7933044),
                                                (3, '1'), (6, [(2, 19822)]),
                                                (8, 1552233784.7933054), (3, '2'), (6, [(2, 18472)]),
                                                (8, 1552233784.7932787), (3, '1'), (5, 'nice'),
                                                (6, [(2, 61070)]), (8, 1552233784.793307), (3, '4'), (5, 'idle'),
                                                (6, [(2, 19068)]),
                                                (8, 1552233784.793278), (3, '0'), (5, 'nice'), (6, [(2, 56549)]),
                                                (8, 1552233784.7933087), (3, '6'),
                                                (5, 'idle'), (6, [(2, 21034)]), (8, 1552233784.7933092), (3, '7'),
                                                (6, [(2, 20859)]),
                                                (8, 1552233784.7932794), (3, '2'), (5, 'nice'), (6, [(2, 60371)]),
                                                (8, 1552233784.7932982), (3, '1'),
                                                (5, 'steal'), (6, [(2, 0)]), (8, 1552233784.7933064), (3, '3'),
                                                (5, 'idle'), (6, [(2, 16523)]),
                                                (8, 1552233784.7933078), (3, '5'), (6, [(2, 20556)]),
                                                (8, 1552233785.7929485), (3, '0'), (5, 'user'),
                                                (6, [(2, 285760)]), (8, 1552233785.7929525), (3, '1'),
                                                (6, [(2, 303522)]), (8, 1552233785.7929554),
                                                (3, '2'), (6, [(2, 293676)]), (8, 1552233785.7929578), (3, '3'),
                                                (6, [(2, 278980)]),
                                                (8, 1552233785.7929602), (3, '4'), (6, [(2, 321944)]),
                                                (0, 'host_a'), (8, 1552233785.7929623),
                                                (9, 1073741824), (2, 'cpu'), (3, '5'), (4, 'cpu'), (5, 'user'),
                                                (6, [(2, 265180)]),
                                                (8, 1552233785.7929668), (3, '2'), (5, 'system'),
                                                (6, [(2, 256623)]), (8, 1552233785.792963), (3, '6'),
                                                (5, 'user'), (6, [(2, 251561)]), (8, 1552233785.7929676), (3, '3'),
                                                (5, 'system'), (6, [(2, 264250)]),
                                                (8, 1552233785.7929661), (3, '1'), (6, [(2, 260028)]),
                                                (8, 1552233785.7929637), (3, '7'), (5, 'user'),
                                                (6, [(2, 278477)]), (8, 1552233785.7929695), (3, '6'),
                                                (5, 'system'), (6, [(2, 275279)]),
                                                (8, 1552233785.792968), (3, '4'), (6, [(2, 257658)]),
                                                (8, 1552233785.7929688), (3, '5'),
                                                (6, [(2, 267355)]), (8, 1552233785.7929716), (3, '0'), (5, 'wait'),
                                                (6, [(2, 41593)]),
                                                (8, 1552233785.7929654), (5, 'system'), (6, [(2, 257242)]),
                                                (8, 1552233785.7929738), (3, '3'), (5, 'wait'),
                                                (6, [(2, 189)]), (8, 1552233785.7929702), (3, '7'), (5, 'system'),
                                                (6, [(2, 258786)]),
                                                (8, 1552233785.7929723), (3, '1'), (5, 'wait'), (6, [(2, 158)]),
                                                (8, 1552233785.7929752), (3, '5'),
                                                (6, [(2, 180)]), (8, 1552233785.7929757), (3, '6'), (6, [(2, 241)]),
                                                (8, 1552233785.792973), (3, '2'),
                                                (6, [(2, 170)]), (8, 1552233785.7929745), (3, '4'), (6, [(2, 179)]),
                                                (8, 1552233785.7929778), (3, '0'),
                                                (5, 'nice'), (6, [(2, 56549)]), (8, 1552233785.7929792), (3, '2'),
                                                (6, [(2, 60372)]),
                                                (8, 1552233785.7929785), (3, '1'), (6, [(2, 61070)]),
                                                (8, 1552233785.792981), (3, '5'), (6, [(2, 55161)]),
                                                (8, 1552233785.79298), (3, '3'), (6, [(2, 71746)]), (0, 'host_a'),
                                                (8, 1552233785.7929804),
                                                (9, 1073741824), (2, 'cpu'), (3, '4'), (4, 'cpu'), (5, 'nice'),
                                                (6, [(2, 66967)]), (8, 1552233785.7929842),
                                                (3, '1'), (5, 'interrupt'), (6, [(2, 0)]), (8, 1552233785.792985),
                                                (3, '2'), (6, [(2, 0)]),
                                                (8, 1552233785.7929857), (3, '3'), (6, [(2, 0)]),
                                                (8, 1552233785.7929862), (3, '4'), (6, [(2, 0)]),
                                                (8, 1552233785.7929866), (3, '5'), (6, [(2, 0)]),
                                                (8, 1552233785.7929873), (3, '6'), (6, [(2, 0)]),
                                                (8, 1552233785.7929878), (3, '7'), (6, [(2, 0)]),
                                                (8, 1552233785.792989), (3, '0'), (5, 'softirq'),
                                                (6, [(2, 202312)]), (8, 1552233785.7929895), (3, '1'),
                                                (6, [(2, 84211)]), (8, 1552233785.7929902),
                                                (3, '2'), (6, [(2, 36560)]), (8, 1552233785.7929907), (3, '3'),
                                                (6, [(2, 12998)]), (8, 1552233785.7929912),
                                                (3, '4'), (6, [(2, 5668)]), (8, 1552233785.7929919), (3, '5'),
                                                (6, [(2, 4424)]), (8, 1552233785.7929924),
                                                (3, '6'), (6, [(2, 1917)]), (8, 1552233785.7929928), (3, '7'),
                                                (6, [(2, 7730)]), (8, 1552233785.7929935),
                                                (3, '0'), (5, 'steal'), (6, [(2, 0)]), (8, 1552233785.7929945),
                                                (3, '1'), (6, [(2, 0)]),
                                                (8, 1552233785.7929764), (3, '7'), (5, 'wait'), (6, [(2, 179)]),
                                                (8, 1552233785.792982), (5, 'nice'),
                                                (6, [(2, 55048)]), (8, 1552233785.792996), (3, '3'), (5, 'steal'),
                                                (6, [(2, 0)]), (8, 1552233785.7929966),
                                                (3, '4'), (6, [(2, 0)]), (8, 1552233785.7929838), (3, '0'),
                                                (5, 'interrupt'), (6, [(2, 0)])])
            self.assertListEqual(
             [0.96, -1.0, -0.98, -0.98, -1.0, -1.0, -1.0, -1.0, 0.9199999999999999, -1.0, -1.0, -1.0, -1.0, -1.0, -0.92,
              -1.0, 0.9207920792079207, -1.0, -1.0, -1.0, -1.0, -0.9603960396039604, -0.9603960396039604, -1.0,
              0.9603960396039604, -1.0, -1.0, -1.0, -1.0, -0.9801980198019802, -0.9801980198019802, -1.0,
              0.9199999999999999, -1.0, -1.0, -1.0, -1.0, -0.98, -1.0, -0.94, 0.8999999999999999, -1.0, -0.98, -1.0,
              -1.0, -1.0, -0.98, -0.94, 0.9795918367346939, -1.0, -1.0, -1.0, -1.0, -1.0, -0.9795918367346939, -1.0,
              0.98, -1.0, -1.0, -1.0, -1.0, -0.98, -1.0, -1.0], collectd_os.collect())
        finally:
            collectd_os.stop()


if __name__ == '__main__':
    unittest.main()
